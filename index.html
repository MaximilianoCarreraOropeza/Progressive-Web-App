<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora del Ciclo de Vida del Service Worker</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .log-item { display: flex; align-items: center; margin-bottom: 10px; }
        .status-icon { font-size: 1.5em; margin-right: 10px; }
        .done { color: green; }
        .pending { color: red; }
    </style>
</head>
<body>
    <h1>Bitácora del Service Worker (PWA)</h1>
    <div id="bitacora">
        <div class="log-item"><span id="instalando" class="status-icon pending">❌</span>Instalando (install)</div>
        <div class="log-item"><span id="instalado" class="status-icon pending">❌</span>Instalado (Cacheado)</div>
        <div class="log-item"><span id="activacion" class="status-icon pending">❌</span>Activación (activate)</div>
        <div class="log-item"><span id="activo" class="status-icon pending">❌</span>Activo (Fetch)</div>
        <div class="log-item"><span id="ocioso" class="status-icon done">✅</span>Ocioso (Idle)</div>
    </div>

    <script>
    // Función para actualizar la bitácora
    function updateBitacora(estado, time) {
        const id = estado.toLowerCase();
        const element = document.getElementById(id);
        if (element) {
            element.classList.replace('pending', 'done');
            element.innerHTML = '✅';
        }
        if (estado === 'instalado' && time) {
            console.log(`[Bitácora] Instalado: ${time}`);
        }
    }

    // Función para manejar los mensajes del Service Worker
    function handleSWMessages(event) {
        const data = event.data;
        console.log(`✅ Mensaje de SW recibido: ${data.estado}`);
        if (data.estado === 'instalado') updateBitacora('instalado');
        if (data.estado === 'activado') updateBitacora('activacion');
        if (data.estado === 'activo') updateBitacora('activo');
    }

    // Función para registrar el Service Worker
    function registerServiceWorker() {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('✅ Registro del Service Worker exitoso con alcance:', registration.scope);
                updateBitacora('instalando');
                checkActiveWorker(registration);
            })
            .catch(error => {
                console.log('❌ Registro del Service Worker fallido:', error);
            });
    }

    // Función para comprobar si hay un trabajador activo
    function checkActiveWorker(registration) {
        const worker = registration.active;
        if (worker) {
            updateBitacora('instalado');
            updateBitacora('activacion');
        }
    }

    // Función principal para inicializar la aplicación
    function init() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', handleSWMessages);
            window.addEventListener('load', registerServiceWorker);
        }
    }

    // Inicializar la aplicación
    init();
    </script>
</body>
</html>